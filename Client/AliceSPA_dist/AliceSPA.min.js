'use strict';var $jscomp={scope:{},findInternal:function(a,c,d){a instanceof String&&(a=String(a));for(var b=a.length,e=0;e<b;e++){var f=a[e];if(c.call(d,f,e,a))return{i:e,v:f}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,d){if(d.get||d.set)throw new TypeError("ES3 does not support getters and setters.");a!=Array.prototype&&a!=Object.prototype&&(a[c]=d.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,d,b){if(c){d=$jscomp.global;a=a.split(".");for(b=0;b<a.length-1;b++){var e=a[b];e in d||(d[e]={});d=d[e]}a=a[a.length-1];b=d[a];c=c(b);c!=b&&null!=c&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6-impl","es3");var AliceSPA=AliceSPA||{};
(function(a){AliceSPA=_.extend({DirectiveHandle:{Functions:{},ServiceInterface:null},Modules:{}},AliceSPA);a.ASPAModule=function(c,d){var b=a.module(c,d);b.getAngular=function(){return a};var e=AliceSPA;e.Modules[c]={};b.ASPADirective=function(a,d,c){var h=e.DirectiveHandle;c||(c=a);h.Functions["set"+c+"Handle"]=function(b,a){return h.ServiceInterface.setHandle(c,b,a)};h.Functions["get"+c+"Handle"]=function(b){return h.ServiceInterface.getHandle(c,b)};return b.directive(a,d)};return b}})(angular);var module=angular.ASPAModule("AliceSPA",[]);module.config(["$injector",function(a){!1===a.has("AliceSPAConfig")&&(console.error("ASPA: Not found AliceSPAConfig. Check /your_app/script/Config/ASPAConfig.js by default."),alert("ASPA: Not found AliceSPAConfig. Check /your_app/script/Config/ASPAConfig.js by default."))}]);module.run(["ASPAErrorService","ASPASessionService",function(a,c){c.checkSession();a.load()}]);module.constant("AliceSPAConfig",_.extend({},AliceSPA.Config.Core));module.ASPADirective("aspaCaptchaImage",function(){var a=null,c=null;return{template:'<img style="{{style}}" ng-click="load();" ng-src="data:image/png;base64,{{captcha.data}}"></img>',scope:!0,controller:["$scope","ASPACaptchaService","ASPADirectiveHandleService",function(d,b,e){d.style=a;d.load=function(){b.getImageCaptcha().then(function(b){d.captcha=b;c&&e.setASPACaptchaImageHandle(c,{id:b.id})})};d.load()}],compile:function(d,b){b.aspaStyle&&(a=b.aspaStyle);b.aspaHandle&&(c=b.aspaHandle)}}},"ASPACaptchaImage");module.service("ASPAAPIProtocolService",["ConfigService","$q","$http","ASPADataService","ASPANotifierService",function(a,c,d,b,e){var f=function(f,k,h,g,r,l,t,n,u){h=h||{};g=g||{};g.headers=g.headers||{};k=(l?a.getAliceSPAApiUrlPrefix():a.getApiUrlPrefix())+k;t&&(l=b.get("userInfo"),_.isEmpty(l)||(g.headers["AliceSPA-UserID"]=l.id,g.headers["AliceSPA-WebToken"]=l.web_token));var m=c.defer(),p=function(){var a=null;"GET"===f&&(a=d.get(k,g));"POST"===f&&(a=d.post(k,h,g));null!==a&&a.then(function(a){a=
a.data;n&&a.sessionID!==b.get("sessionId")&&b.set("sessionId",a.sessionID);"SUCCESS"===a.status?(u||(a=a.data),m.resolve(a)):(m.reject(a.errors),a.APIException&&console.error("! APIException",f,k,h,g,r,a,a.APIException))},function(a){m.reject(a.errors)})};n?e.registerSessionId(function(a){a?((a=b.get("sessionId"))&&(g.headers["AliceSPA-SessionID"]=a),p()):m.reject({})}):p();return m.promise};return{get:function(a,b,d){return f("GET",a,null,b,d,!1,!0,!0,!1)},post:function(a,b,d,c){return f("POST",
a,b,d,c,!1,!0,!0,!1)},ASPAGet:function(a,b,d){return f("GET",a,null,b,d,!0,!0,!0,!1)},ASPAPost:function(a,b,d,c){return f("POST",a,b,d,c,!0,!0,!0,!1)},VanillaGet:function(a,b,d,c){return f("GET",a,null,d,c,b,!1,!1,!0)},VanillaPost:function(a,b,d,c,e){return f("POST",a,b,c,e,d,!1,!1,!0)}}}]);module.service("ASPAAccountService",["ASPAAPIProtocolService","ASPADataService",function(a,c){return{register:function(d,b){if(_.isEmpty(d))return!1;d.password=(new Hashes.SHA256).hex(b);return a.ASPAPost("/account/register",d).then(function(a){c.set("userInfo",a);return a})},registerByUserName:function(a,b){return this.register({user_name:a},b)},registerByEmail:function(a,b){return this.register({email:a},b)},registerByTelephone:function(a,b){return this.register({telephone:a},b)},login:function(d,
b){if(_.isEmpty(d))return!1;d.password=(new Hashes.SHA256).hex(b);return a.ASPAPost("/account/login",d).then(function(a){c.set("userInfo",a);return a})},loginByUserName:function(a,b){return this.login({user_name:a},b)},loginByTelephone:function(a,b){return this.login({telephone:a},b)},loginByEmail:function(a,b){return this.login({email:a},b)},getUserInfo:function(){return c.get("userInfo")},isLoggedIn:function(){return!!c.get("userInfo")},logout:function(){return a.ASPAPost("/account/logout")}}}]);module.service("ASPACaptchaService",["ASPAAPIProtocolService",function(a){return{getImageCaptcha:function(){return a.ASPAGet("/captcha/image")}}}]);module.service("ConfigService",["AliceSPAConfig",function(a){return{getUrlPrefix:function(){return a.Protocol+"://"+a.ServerHost+":"+a.ServerPort},getApiUrlPrefix:function(){return this.getUrlPrefix()+a.ApiPath},getAliceSPAApiUrlPrefix:function(){return this.getUrlPrefix()+a.AliceSPAApiPath}}}]);module.service("ASPADataService",[function(){var a={};localStorage&&!_.isEmpty(localStorage.AliceSPA_Data)&&(a=JSON.parse(localStorage.AliceSPA_Data));return{set:function(c,d){a[c]=d;localStorage&&(localStorage.AliceSPA_Data=JSON.stringify(a))},get:function(c){return a[c]},getAll:function(){return a}}}]);module.service("ASPADirectDatabaseService",["ASPAAPIProtocolService",function(a){var c=function(d,b,c,f,q,k){return(k?a.ASPAPost:a.post)(d,{table:b,action:c,where:q,data:f})};return{select:function(a,b,e,f){c(a,b,"select",e,f,!1)},insert:function(a,b,e){c(a,b,"insert",e,null,!1)},update:function(a,b,e,f){c(a,b,"update",e,f,!1)},remove:function(a,b,e){c(a,b,"delete",null,e,!1)},ASPASelect:function(a,b,e,f){c(a,b,"select",e,f,!0)},ASPAInsert:function(a,b,e){c(a,b,"insert",e,null,!0)},ASPAUpdate:function(a,
b,e,f){c(a,b,"update",e,f,!0)},ASPARemove:function(a,b,e){c(a,b,"delete",null,e,!0)}}}]);module.service("ASPADirectiveHandleService",[function(){var a={};AliceSPA.DirectiveHandle.ServiceInterface={setHandle:function(c,d,b){a[c]=a[c]||{};a[c][d]=b},getHandle:function(c,d){return a[c]&&a[c][d]?a[c][d]:void 0}};return _.extend({},AliceSPA.DirectiveHandle.Functions)}]);module.service("ASPAErrorService",["ASPANotifierService","ASPAAPIProtocolService","ASPADataService",function(a,c,d){return{getErrors:function(){return d.get("errors")},getError:function(a){var c=d.get("errors");return _.find(c,function(c){return c.CODE===a})},load:function(){c.ASPAGet("/environment/errors").then(function(b){d.set("errors",b);a.notifyError(!0)},function(b){a.notifyError(!1)})}}}]);module.service("ASPANotifierService",[function(){var a={},c=function(b,c){!0===a[b]||!1===a[b]?c(a[b]):(a[b]=a[b]||[],a[b].push(c))},d=function(b,c){var d=a[b];a[b]=c;_.isEmpty(d)||_.each(d,function(a){a(c)})};return{registerError:function(a){c("error",a)},notifyError:function(a){d("error",a)},registerUserInfo:function(a){c("userInfo",a)},notifyUserInfo:function(a){d("userInfo",a)},registerSessionId:function(a){c("sessionId",a)},notifySessionId:function(a){d("sessionId",a)}}}]);module.service("ASPASessionService",["ASPADataService","ASPANotifierService","ASPAAPIProtocolService",function(a,c,d){var b=function(){return a.get("sessionId")};return{checkSession:function(){var e={headers:{}},f=b();f&&(e.headers["AliceSPA-SessionID"]=f);d.VanillaGet("/environment/checkSession",!0,e).then(function(b){b.sessionID!==f&&a.set("sessionId",b.sessionID);c.notifySessionId(!0)},function(a){c.notifySessionId(!1)})},getSessionId:b,clearSessions:function(){d.ASPAPost("/environment/clearSessions")}}}]);
